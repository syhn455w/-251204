<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A1 機捷時刻表</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#1e1b4b"> <!-- Dark Purple Theme -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="桃園機場捷運 A1 台北車站發車時刻表 (往 A8/A9)">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        express: {
                            light: '#f3e8ff', // purple-100
                            DEFAULT: '#9333ea', // purple-600
                            dark: '#581c87', // purple-900
                        },
                        commuter: {
                            light: '#dbeafe', // blue-100
                            DEFAULT: '#2563eb', // blue-600
                            dark: '#1e3a8a', // blue-900
                        }
                    },
                    animation: {
                        'pulse-border': 'pulse-border 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'pulse-border': {
                            '0%, 100%': { borderColor: 'rgba(147, 51, 234, 1)' },
                            '50%': { borderColor: 'rgba(147, 51, 234, 0.3)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Import Map for React & Icons -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            background-color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
        import React, { useState, useEffect, useMemo, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Train, Clock, MapPin, RefreshCw, Info, ArrowRight, AlertCircle } from 'lucide-react';

        // --- Types ---
        type TrainType = 'Express' | 'Commuter';

        interface TrainSchedule {
            id: string;
            departureTime: string; // HH:mm
            type: TrainType;
        }

        interface EnrichedTrain extends TrainSchedule {
            arrivalA8: string;
            arrivalA9: string;
            minutesUntil: number;
        }

        interface PatternItem {
            m: number;
            t: TrainType;
        }

        // --- Logic / Service Layer ---
        // Using a static class to organize the business logic requested
        class ScheduleService {
            // Helper to add minutes to a time string
            static addMinutes(timeStr: string, minutesToAdd: number): string {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const date = new Date();
                date.setHours(hours, minutes, 0, 0);
                date.setMinutes(date.getMinutes() + minutesToAdd);
                
                return date.toLocaleTimeString('en-GB', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
            }

            // Generate the hardcoded daily schedule based on prompt rules
            static generateDailySchedule(): TrainSchedule[] {
                const schedule: TrainSchedule[] = [];
                let idCounter = 1;

                const addTrain = (hour: number, minute: number, type: TrainType) => {
                    schedule.push({
                        id: `T-${idCounter++}`,
                        departureTime: `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`,
                        type
                    });
                };

                // 05:00
                addTrain(5, 30, 'Express');

                // 06:00 to 17:00 (Standard Pattern)
                const standardPattern: PatternItem[] = [
                    { m: 0, t: 'Express' }, { m: 8, t: 'Commuter' }, 
                    { m: 15, t: 'Express' }, { m: 23, t: 'Commuter' },
                    { m: 30, t: 'Express' }, { m: 38, t: 'Commuter' }, 
                    { m: 45, t: 'Express' }, { m: 53, t: 'Commuter' }
                ];

                for (let h = 6; h <= 17; h++) {
                    standardPattern.forEach(p => addTrain(h, p.m, p.t));
                }

                // 18:00 (Peak Hour)
                const peakPattern: PatternItem[] = [
                    { m: 0, t: 'Express' }, { m: 8, t: 'Commuter' }, 
                    { m: 15, t: 'Express' }, { m: 19, t: 'Commuter' },
                    { m: 23, t: 'Commuter' }, { m: 30, t: 'Express' }, 
                    { m: 34, t: 'Commuter' }, { m: 38, t: 'Commuter' }, 
                    { m: 45, t: 'Express' }, { m: 53, t: 'Commuter' }
                ];
                peakPattern.forEach(p => addTrain(18, p.m, p.t));

                // 19:00 to 22:00 (Standard Pattern)
                for (let h = 19; h <= 22; h++) {
                    standardPattern.forEach(p => addTrain(h, p.m, p.t));
                }

                // 23:00 (Late Night)
                const latePattern: PatternItem[] = [
                    { m: 0, t: 'Express' }, { m: 8, t: 'Commuter' }, 
                    { m: 23, t: 'Commuter' }, { m: 38, t: 'Commuter' }
                ];
                latePattern.forEach(p => addTrain(23, p.m, p.t));

                return schedule;
            }

            // Calculate details (arrivals, diffs)
            static enrichSchedule(schedule: TrainSchedule[], currentTime: Date): EnrichedTrain[] {
                const currentTotalMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();

                return schedule.map(train => {
                    // Calculate Arrival
                    let a8Time, a9Time;
                    if (train.type === 'Express') {
                        a8Time = this.addMinutes(train.departureTime, 21);
                        // Express to A9 requires transfer logic visual, but time is calculated as +26 base
                        a9Time = this.addMinutes(train.departureTime, 26); 
                    } else {
                        a8Time = this.addMinutes(train.departureTime, 26);
                        a9Time = this.addMinutes(train.departureTime, 33);
                    }

                    // Calculate Diff
                    const [h, m] = train.departureTime.split(':').map(Number);
                    const trainTotalMinutes = h * 60 + m;
                    
                    // Handle next day wrap-around conceptually (though schedule ends at 23:38)
                    let minutesUntil = trainTotalMinutes - currentTotalMinutes;
                    if (minutesUntil < 0 && h < 4) { // Assume early morning train is next day
                         minutesUntil += 24 * 60;
                    }

                    return {
                        ...train,
                        arrivalA8: a8Time,
                        arrivalA9: a9Time,
                        minutesUntil
                    };
                }).filter(t => t.minutesUntil >= 0) // Filter out past trains
                  .sort((a, b) => a.minutesUntil - b.minutesUntil);
            }
        }

        // --- UI Components ---

        const ClockDisplay = () => {
            const [time, setTime] = useState(new Date());

            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            return (
                <div className="flex flex-col items-center justify-center">
                    <div className="text-4xl font-mono font-bold tracking-wider text-white">
                        {time.toLocaleTimeString('en-GB', { hour12: false })}
                    </div>
                    <div className="text-xs text-slate-400 mt-1 uppercase tracking-widest">目前時間</div>
                </div>
            );
        };

        const TrainCard = ({ train, isNext }: { train: EnrichedTrain, isNext: boolean }) => {
            const isExpress = train.type === 'Express';
            
            // Base Styles
            const bgClass = isExpress ? 'bg-white' : 'bg-white';
            const borderClass = isExpress 
                ? 'border-l-8 border-express' 
                : 'border-l-8 border-commuter';
            
            const badgeBg = isExpress ? 'bg-express text-white' : 'bg-commuter text-white';
            const badgeText = isExpress ? '直達車 Express' : '普通車 Commuter';

            // Highlight Styles for "Next Train"
            const containerClasses = isNext 
                ? `transform scale-[1.02] shadow-xl z-10 my-4 border-2 ${isExpress ? 'border-express' : 'border-commuter'} animate-pulse-border`
                : 'shadow-sm opacity-90 scale-100 border border-slate-200';

            return (
                <div className={`relative rounded-lg overflow-hidden transition-all duration-500 p-4 ${bgClass} ${borderClass} ${containerClasses}`}>
                    {isNext && (
                        <div className="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg shadow-sm animate-pulse">
                            即將發車
                        </div>
                    )}

                    {/* Top Row: Type & Countdown */}
                    <div className="flex justify-between items-center mb-4">
                        <span className={`text-xs font-bold px-2 py-1 rounded ${badgeBg}`}>
                            {badgeText}
                        </span>
                        <div className="text-right">
                             {isNext ? (
                                <span className="text-red-600 font-bold text-lg">
                                    {train.minutesUntil === 0 ? '進站中' : `約 ${train.minutesUntil} 分後`}
                                </span>
                             ) : (
                                <span className="text-slate-500 text-sm">約 {train.minutesUntil} 分後</span>
                             )}
                        </div>
                    </div>

                    {/* Grid Layout for Times */}
                    <div className="grid grid-cols-3 gap-2 text-center divide-x divide-slate-100">
                        {/* A1 */}
                        <div className="flex flex-col items-center">
                            <span className="text-xs text-slate-400 mb-1">A1 出發</span>
                            <span className="text-2xl font-mono font-bold text-slate-800">
                                {train.departureTime}
                            </span>
                        </div>

                        {/* A8 */}
                        <div className="flex flex-col items-center">
                            <span className="text-xs text-slate-400 mb-1">A8 抵達</span>
                            <span className="text-xl font-mono font-semibold text-slate-600">
                                {train.arrivalA8}
                            </span>
                        </div>

                        {/* A9 */}
                        <div className="flex flex-col items-center">
                            <span className="text-xs text-slate-400 mb-1">A9 抵達</span>
                            <div className="flex flex-col items-center">
                                <span className="text-xl font-mono font-semibold text-slate-600">
                                    {train.arrivalA9}
                                </span>
                                {isExpress && (
                                    <span className="text-[10px] text-orange-500 font-medium mt-1 leading-tight flex items-center justify-center bg-orange-50 px-1 rounded border border-orange-100 whitespace-nowrap">
                                        <AlertCircle className="w-3 h-3 mr-0.5" /> 需在A8轉乘
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [now, setNow] = useState(new Date());
            // Removed generic syntax to prevent Babel parsing errors
            const [schedule, setSchedule] = useState([]);
            const [loading, setLoading] = useState(true);

            // 1. Generate Static Schedule Once
            const dailySchedule = useMemo(() => ScheduleService.generateDailySchedule(), []);

            // 2. Refresh Logic
            const refreshSchedule = useCallback(() => {
                setLoading(true);
                const currentTime = new Date();
                setNow(currentTime);
                
                // Simulate "calculation" delay for UX
                setTimeout(() => {
                    const nextTrains = ScheduleService.enrichSchedule(dailySchedule, currentTime);
                    setSchedule(nextTrains.slice(0, 10)); // Keep only next 10
                    setLoading(false);
                }, 300);
            }, [dailySchedule]);

            // 3. Auto-refresh interval (every 30s to keep relative times accurate)
            useEffect(() => {
                refreshSchedule();
                const interval = setInterval(refreshSchedule, 30000);
                return () => clearInterval(interval);
            }, [refreshSchedule]);

            // 4. Force PWA Manifest injection
            useEffect(() => {
                const manifest = {
                    "name": "A1 機捷時刻表",
                    "short_name": "A1 時刻表",
                    "start_url": ".",
                    "display": "standalone",
                    "background_color": "#1e1b4b",
                    "theme_color": "#1e1b4b",
                    "icons": [
                        { "src": "https://cdn-icons-png.flaticon.com/512/3061/3061341.png", "sizes": "192x192", "type": "image/png" },
                        { "src": "https://cdn-icons-png.flaticon.com/512/3061/3061341.png", "sizes": "512x512", "type": "image/png" }
                    ]
                };
                const stringManifest = JSON.stringify(manifest);
                const blob = new Blob([stringManifest], {type: 'application/json'});
                const manifestURL = URL.createObjectURL(blob);
                const link = document.createElement('link');
                link.rel = 'manifest';
                link.href = manifestURL;
                document.head.appendChild(link);
            }, []);

            return (
                <div className="min-h-screen bg-slate-100 flex flex-col max-w-md mx-auto shadow-2xl overflow-hidden border-x border-slate-200">
                    {/* Header */}
                    <header className="bg-slate-900 pt-8 pb-6 px-6 rounded-b-3xl shadow-lg relative z-20 shrink-0">
                        <div className="flex justify-between items-start mb-4">
                            <div className="flex items-center text-slate-300">
                                <Train className="w-5 h-5 mr-2" />
                                <span className="font-semibold tracking-wide text-sm">桃園機場捷運</span>
                            </div>
                            <button 
                                onClick={refreshSchedule} 
                                className="text-slate-400 hover:text-white transition active:rotate-180 duration-300"
                                aria-label="重新整理"
                            >
                                <RefreshCw className="w-5 h-5" />
                            </button>
                        </div>
                        
                        <ClockDisplay />

                        <div className="mt-6 flex items-center justify-between text-white px-2">
                            <div className="flex flex-col">
                                <span className="text-2xl font-bold">A1</span>
                                <span className="text-xs text-slate-400">台北車站</span>
                            </div>
                            <div className="flex items-center space-x-2 opacity-50">
                                <div className="h-0.5 w-8 bg-white"></div>
                                <ArrowRight className="w-4 h-4" />
                                <div className="h-0.5 w-8 bg-white"></div>
                            </div>
                            <div className="flex flex-col text-right">
                                <span className="text-2xl font-bold">A8 / A9</span>
                                <span className="text-xs text-slate-400">長庚 / 林口</span>
                            </div>
                        </div>
                    </header>

                    {/* Schedule List */}
                    <main className="flex-1 overflow-y-auto p-4 space-y-3 relative no-scrollbar">
                        {loading ? (
                            <div className="flex flex-col items-center justify-center h-40 text-slate-400 animate-pulse">
                                <span className="mb-2">時刻表載入中...</span>
                            </div>
                        ) : schedule.length > 0 ? (
                            <>
                                {schedule.map((train, index) => (
                                    <TrainCard 
                                        key={train.id} 
                                        train={train} 
                                        isNext={index === 0} 
                                    />
                                ))}
                                <div className="text-center py-6">
                                    <p className="text-slate-400 text-sm">已顯示所有即將發車班次</p>
                                </div>
                            </>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-64 text-slate-500">
                                <Info className="w-12 h-12 mb-2 opacity-50" />
                                <p className="text-lg font-medium">今日已無班次</p>
                                <p className="text-sm">服務將於明日 05:00 恢復</p>
                            </div>
                        )}
                    </main>

                    {/* Footer */}
                    <footer className="bg-white border-t border-slate-200 p-4 shrink-0 safe-area-bottom">
                        <div className="flex items-start space-x-2 text-xs text-slate-500">
                            <Info className="w-4 h-4 shrink-0 mt-0.5" />
                            <p>
                                時刻表依據 2025 年官方資訊。
                                行車時間僅供參考。
                                <strong>往 A9 林口之直達車需於 A8 長庚醫院站轉乘。</strong>
                            </p>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
