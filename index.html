<!DOCTYPE html>
<html lang="zh-TW" class="antialiased h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>A1 機捷時刻表 | 台北車站發車資訊</title>
    
    <!-- PWA Settings -->
    <meta id="theme-color-meta" name="theme-color" content="#FFFFFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="機捷A1">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Noto Sans TC', 'sans-serif'],
                        mono: ['SF Mono', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'slide-up-fade': 'slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUpFade: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    spacing: {
                        'safe-top': 'env(safe-area-inset-top)',
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Ensure HTML background matches theme to avoid white bars on bounce */
        html { height: 100dvh; width: 100vw; overflow: hidden; background: #FFFFFF; }
        html.dark { background: #000000; }
        
        body { 
            height: 100%; width: 100%; overflow: hidden; position: fixed; inset: 0;
            -webkit-font-smoothing: antialiased; overscroll-behavior: none;
            transition: background-color 0.3s ease;
        }
        
        .tabular-nums { font-variant-numeric: tabular-nums; }

        /* Boutique Gradient Background */
        .bg-boutique-light {
            background: radial-gradient(circle at 0% 0%, #E0E7FF 0%, #F8FAFC 40%, #FFFFFF 100%);
        }
        .dark .bg-boutique-dark {
            background: radial-gradient(circle at 50% 0%, #1E1B4B 0%, #000000 60%);
        }

        /* Minimalist Card */
        .card-minimal {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        }
        .dark .card-minimal {
            background: rgba(28, 28, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: none;
        }

        /* Express Highlight */
        .card-express-bg {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.25);
        }
        .dark .card-express-bg {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            box-shadow: 0 8px 20px -6px rgba(124, 58, 237, 0.4);
        }

        /* Nav Blur */
        .nav-blur {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .dark .nav-blur {
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* Loading Screen */
        #preloader {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #FFFFFF; transition: opacity 0.3s ease-out;
        }
        @media (prefers-color-scheme: dark) { #preloader { background: #000000; } }
        
        .loader-pulse { animation: pulse-logo 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-logo { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.95); } }
    </style>
</head>
<body class="bg-boutique-light dark:bg-boutique-dark text-slate-900 dark:text-white">
    
    <div id="preloader">
        <div class="w-16 h-16 bg-black dark:bg-white rounded-2xl flex items-center justify-center mb-4 loader-pulse">
            <span class="text-white dark:text-black font-bold text-2xl tracking-tighter">A1</span>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
        import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Train, RefreshCw, ChevronRight, Zap, Moon, Sun, Circle, Share, ArrowUpRight, Clock, Download } from 'lucide-react';

        const vibrate = () => { if (navigator.vibrate) navigator.vibrate(5); };

        class ScheduleService {
            static addMinutes(timeStr, mins) {
                const [h, m] = timeStr.split(':').map(Number);
                const d = new Date(); d.setHours(h, m + mins, 0, 0);
                return d.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', hour12: false });
            }
            static generateDailySchedule() {
                const schedule = [];
                let id = 1;
                const add = (h, m, t) => schedule.push({ id: `T-${id++}`, departureTime: `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`, type: t });
                add(5, 30, 'Express');
                const std = [{m:0,t:'Express'},{m:8,t:'Commuter'},{m:15,t:'Express'},{m:23,t:'Commuter'},{m:30,t:'Express'},{m:38,t:'Commuter'},{m:45,t:'Express'},{m:53,t:'Commuter'}];
                for(let h=6; h<=17; h++) std.forEach(p=>add(h,p.m,p.t));
                const peak = [{m:0,t:'Express'},{m:8,t:'Commuter'},{m:15,t:'Express'},{m:19,t:'Commuter'},{m:23,t:'Commuter'},{m:30,t:'Express'},{m:34,t:'Commuter'},{m:38,t:'Commuter'},{m:45,t:'Express'},{m:53,t:'Commuter'}];
                peak.forEach(p=>add(18,p.m,p.t));
                for(let h=19; h<=22; h++) std.forEach(p=>add(h,p.m,p.t));
                const late = [{m:0,t:'Express'},{m:8,t:'Commuter'},{m:23,t:'Commuter'},{m:38,t:'Commuter'}];
                late.forEach(p=>add(23,p.m,p.t));
                return schedule;
            }
            static enrichSchedule(schedule, now) {
                const nowMins = now.getHours()*60 + now.getMinutes();
                return schedule.map(t => {
                    const [h, m] = t.departureTime.split(':').map(Number);
                    let diff = (h*60 + m) - nowMins;
                    if(diff < -1080) diff += 1440;
                    const isExp = t.type === 'Express';
                    return {
                        ...t,
                        arrivalA8: this.addMinutes(t.departureTime, isExp ? 21 : 26),
                        arrivalA9: this.addMinutes(t.departureTime, isExp ? 26 : 33),
                        minutesUntil: diff
                    };
                }).filter(t => t.minutesUntil >= 0).sort((a,b) => a.minutesUntil - b.minutesUntil);
            }
        }

        const InstallPrompt = () => {
            const [showIOS, setShowIOS] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);

            useEffect(() => {
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator['standalone'];
                if (isStandalone) return;

                const handler = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handler);

                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window['MSStream'];
                const closed = localStorage.getItem('installPromptClosed');
                if (isIOS && !closed) {
                    setTimeout(() => setShowIOS(true), 2000);
                }

                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallClick = async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    setDeferredPrompt(null);
                }
            };

            const closeIOS = () => {
                setShowIOS(false);
                localStorage.setItem('installPromptClosed', 'true');
            };

            if (deferredPrompt) {
                return (
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 animate-slide-up-fade w-max">
                        <button 
                            onClick={handleInstallClick}
                            className="bg-black dark:bg-white text-white dark:text-black font-bold py-3 px-6 rounded-full shadow-xl flex items-center gap-2 active:scale-95 transition-transform"
                        >
                            <Download className="w-4 h-4" />
                            安裝 App
                        </button>
                    </div>
                );
            }

            if (showIOS) {
                return (
                    <div className="fixed bottom-0 left-0 right-0 z-50 p-4 pb-safe-bottom animate-slide-up-fade">
                        <div className="bg-white/95 dark:bg-[#1C1C1E] backdrop-blur-md rounded-2xl p-4 shadow-2xl border border-black/5 dark:border-white/10 relative">
                            <button onClick={closeIOS} className="absolute top-4 right-4 p-2 opacity-50 hover:opacity-100"><span className="text-xl leading-none">&times;</span></button>
                            <div className="flex gap-4 items-center pr-8">
                                <div className="w-12 h-12 bg-black dark:bg-white rounded-xl flex items-center justify-center shrink-0">
                                    <span className="text-white dark:text-black font-bold text-lg">A1</span>
                                </div>
                                <div>
                                    <h3 className="font-bold text-sm">安裝到主畫面</h3>
                                    <p className="text-xs opacity-60 mt-0.5">點擊 <Share className="w-3 h-3 inline"/> 分享 > 加入主畫面</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        const Header = ({ showExpressOnly, setShowExpressOnly, isDark, toggleTheme }) => {
            const [time, setTime] = useState(new Date());
            useEffect(() => { 
                const t = setInterval(() => setTime(new Date()), 1000); 
                return ()=>clearInterval(t); 
            }, []);

            return (
                <header className="fixed top-0 left-0 right-0 z-30 px-6 pt-safe-top pb-3 nav-blur transition-colors">
                    <div className="flex justify-between items-center pt-4 pb-2">
                        <div className="flex flex-col">
                            <h1 className="text-3xl font-bold tracking-tight flex items-center gap-2">
                                機捷 A1
                                <span className="text-xs font-normal px-2 py-0.5 rounded-md bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400">台北車站</span>
                            </h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className="font-mono text-2xl font-medium tabular-nums opacity-80">
                                {time.toLocaleTimeString('en-GB', { hour12: false, hour:'2-digit', minute:'2-digit' })}
                            </span>
                            <button onClick={() => { vibrate(); toggleTheme(); }} className="w-8 h-8 rounded-full flex items-center justify-center bg-slate-100 dark:bg-slate-800 transition-colors active:scale-90">
                                {isDark ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
                            </button>
                        </div>
                    </div>
                    
                    {/* Minimalist Filter Tabs */}
                    <div className="flex bg-slate-100 dark:bg-slate-800/80 p-1 rounded-xl mt-2 relative">
                        <div className={`absolute top-1 bottom-1 w-[calc(50%-4px)] bg-white dark:bg-[#2C2C2E] rounded-lg shadow-sm transition-all duration-300 ease-out ${showExpressOnly ? 'left-1' : 'left-[calc(50%+2px)]'}`}></div>
                        <button onClick={() => { vibrate(); setShowExpressOnly(true); }} className={`flex-1 relative z-10 flex items-center justify-center gap-1.5 py-2 rounded-lg text-xs font-bold transition-colors ${showExpressOnly ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-500 dark:text-slate-400'}`}>
                            <Zap className="w-3.5 h-3.5" /> 直達車
                        </button>
                        <button onClick={() => { vibrate(); setShowExpressOnly(false); }} className={`flex-1 relative z-10 flex items-center justify-center gap-1.5 py-2 rounded-lg text-xs font-bold transition-colors ${!showExpressOnly ? 'text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>
                            全部
                        </button>
                    </div>
                </header>
            );
        };

        const TrainCard = ({ train, isNext, index }) => {
            const isExp = train.type === 'Express';
            const isDeparting = train.minutesUntil <= 0;
            const cardClass = isExp ? 'card-express-bg text-white border-none' : 'card-minimal text-slate-900 dark:text-slate-100';

            return (
                <div 
                    className={`relative rounded-2xl p-5 mb-4 transition-all active:scale-[0.98] ${cardClass} animate-slide-up-fade`}
                    style={{ animationDelay: `${index * 0.05}s` }}
                >
                    <div className="flex justify-between items-start mb-5">
                        <div className="flex items-center gap-2">
                            {isExp ? <Zap className="w-4 h-4 fill-white" /> : <Circle className="w-3 h-3 fill-slate-400 text-slate-400" />}
                            <span className={`text-xs font-bold tracking-wide ${isExp ? 'opacity-90' : 'opacity-60'}`}>
                                {isExp ? 'EXPRESS 直達' : 'COMMUTER 普通'}
                            </span>
                        </div>
                        <div className="flex flex-col items-end">
                            <span className={`text-5xl font-bold tabular-nums leading-none tracking-tight ${isDeparting ? 'text-4xl' : ''}`}>
                                {isDeparting ? '已發車' : train.minutesUntil}
                            </span>
                            {!isDeparting && <span className={`text-sm font-medium mt-1 ${isExp ? 'opacity-80' : 'opacity-50'}`}>分鐘後</span>}
                        </div>
                    </div>

                    <div className="flex items-end justify-between relative">
                        <div>
                            <span className={`text-xs font-bold block mb-0.5 opacity-60`}>A1 發車</span>
                            <span className="text-4xl font-mono font-bold tracking-tight leading-none">{train.departureTime}</span>
                        </div>
                        <div className="flex-1 mx-4 pb-2 relative flex items-center justify-center">
                            <div className={`h-[2px] w-full rounded-full ${isExp ? 'bg-white/30' : 'bg-slate-200 dark:bg-slate-700'}`}></div>
                            <div className="absolute top-1/2 -translate-y-1/2 flex flex-col items-center">
                                <div className={`w-2 h-2 rounded-full mb-1 ${isExp ? 'bg-white' : 'bg-slate-400 dark:bg-slate-500'}`}></div>
                                <span className={`text-xs font-mono font-bold ${isExp ? 'text-white' : 'text-slate-500 dark:text-slate-400'}`}>{train.arrivalA8}</span>
                            </div>
                        </div>
                        <div className="text-right">
                            <span className={`text-xs font-bold block mb-0.5 opacity-60`}>A9 抵達</span>
                            <span className="text-2xl font-mono font-bold tracking-tight leading-none">{train.arrivalA9}</span>
                        </div>
                    </div>
                    {isExp && isNext && <div className="absolute top-4 right-4 w-2 h-2 bg-white rounded-full animate-ping"></div>}
                </div>
            );
        };

        const App = () => {
            const [schedule, setSchedule] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isDark, setIsDark] = useState(() => { 
                const saved = localStorage.getItem('theme');
                if (saved) return saved === 'dark';
                return window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            const [showExpressOnly, setShowExpressOnly] = useState(() => localStorage.getItem('filterExpress') === 'true');
            const scrollRef = useRef(null);

            // Preloader fade out
            useEffect(() => {
                const preloader = document.getElementById('preloader');
                if (preloader) { 
                    setTimeout(() => { preloader.style.opacity = '0'; setTimeout(() => preloader.remove(), 300); }, 300); 
                }
            }, []);

            // Theme Effect
            useEffect(() => {
                const meta = document.getElementById('theme-color-meta');
                if (isDark) { 
                    document.documentElement.classList.add('dark'); 
                    localStorage.setItem('theme', 'dark');
                    meta.setAttribute('content', '#000000');
                } else { 
                    document.documentElement.classList.remove('dark'); 
                    localStorage.setItem('theme', 'light'); 
                    meta.setAttribute('content', '#FFFFFF');
                }
            }, [isDark]);

            useEffect(() => { localStorage.setItem('filterExpress', showExpressOnly); }, [showExpressOnly]);

            // --- Dynamic PWA Manifest Generation ---
            useEffect(() => {
                const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512; const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#000000'; ctx.fillRect(0, 0, 512, 512);
                ctx.fillStyle = '#FFFFFF'; ctx.font = 'bold 240px -apple-system, sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('A1', 256, 256);
                const iconUrl = canvas.toDataURL('image/png');
                
                const setLink = (rel, url) => { let l = document.querySelector(`link[rel="${rel}"]`); if (!l) { l = document.createElement('link'); l.rel = rel; document.head.appendChild(l); } l.href = url; };
                setLink('icon', iconUrl); setLink('apple-touch-icon', iconUrl);
                
                const manifest = { 
                    "name": "機捷A1", 
                    "short_name": "機捷A1", 
                    "start_url": ".", 
                    "display": "standalone", 
                    "background_color": "#000000", 
                    "theme_color": "#000000", 
                    "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/png" }] 
                };
                const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
                setLink('manifest', manifestURL);
            }, []);

            // Data
            const daily = useMemo(() => ScheduleService.generateDailySchedule(), []);
            const fetchSchedule = useCallback(async () => {
                setLoading(true);
                return new Promise(resolve => setTimeout(() => { 
                    setSchedule(ScheduleService.enrichSchedule(daily, new Date())); 
                    setLoading(false); resolve(); 
                }, 400));
            }, [daily]);

            useEffect(() => { fetchSchedule(); const i = setInterval(fetchSchedule, 30000); return ()=>clearInterval(i); }, [fetchSchedule]);

            // Pull to Refresh
            const [pullY, setPullY] = useState(0);
            const [refreshing, setRefreshing] = useState(false);
            const startY = useRef(0);
            const handleTouchStart = (e) => { if (scrollRef.current.scrollTop === 0) startY.current = e.touches[0].clientY; };
            const handleTouchMove = (e) => { if (scrollRef.current.scrollTop <= 0 && !refreshing) { const diff = e.touches[0].clientY - startY.current; if (diff > 0) setPullY(Math.min(diff * 0.4, 80)); } };
            const handleTouchEnd = () => { if (pullY > 50) { vibrate(); setRefreshing(true); setPullY(50); fetchSchedule().finally(() => { setRefreshing(false); setPullY(0); }); } else { setPullY(0); } };

            const displaySchedule = useMemo(() => {
                let list = schedule;
                if (showExpressOnly) list = list.filter(t => t.type === 'Express');
                return list.slice(0, 10);
            }, [schedule, showExpressOnly]);

            return (
                <div className="fixed inset-0 flex flex-col max-w-md mx-auto">
                    <Header refresh={fetchSchedule} showExpressOnly={showExpressOnly} setShowExpressOnly={setShowExpressOnly} isDark={isDark} toggleTheme={() => setIsDark(!isDark)} />
                    
                    <main 
                        ref={scrollRef}
                        className="flex-1 overflow-y-auto overflow-x-hidden relative pt-36 pb-4 no-scrollbar touch-pan-y" 
                        onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}
                        style={{ transition: refreshing ? 'transform 0.4s cubic-bezier(0.16, 1, 0.3, 1)' : 'transform 0.2s ease-out' }}
                    >
                        <div className="absolute left-0 right-0 flex justify-center pointer-events-none" style={{ top: '120px', transform: `translateY(${pullY - 30}px)`, opacity: pullY > 10 ? 1 : 0 }}>
                            <div className={`p-2 bg-white dark:bg-slate-800 rounded-full shadow-lg ${refreshing ? 'animate-spin' : ''}`} style={{ transform: `rotate(${pullY * 3}deg)` }}><RefreshCw className="w-4 h-4 text-slate-900 dark:text-white" /></div>
                        </div>

                        <div className="px-5 pb-2 space-y-2 min-h-full transition-transform duration-300" style={{ transform: `translateY(${pullY}px)` }}>
                            {loading && !refreshing ? (
                                <div className="space-y-4 pt-2">
                                    {[1,2,3].map(i => <div key={i} className="h-32 bg-slate-200 dark:bg-slate-800 rounded-2xl animate-pulse"></div>)}
                                </div>
                            ) : displaySchedule.length > 0 ? (
                                displaySchedule.map((t, i) => <TrainCard key={t.id} train={t} isNext={i===0} index={i} />)
                            ) : (
                                <div className="flex flex-col items-center justify-center pt-32 opacity-60">
                                    <div className="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4"><Clock className="w-8 h-8 text-slate-400" /></div>
                                    <p className="text-sm font-medium">今日已無班次</p>
                                    {showExpressOnly && <button onClick={() => { vibrate(); setShowExpressOnly(false); }} className="mt-4 px-4 py-2 bg-slate-200 dark:bg-slate-800 rounded-lg text-xs font-bold active:scale-95">顯示所有車種</button>}
                                </div>
                            )}
                        </div>
                    </main>
                    <InstallPrompt />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
